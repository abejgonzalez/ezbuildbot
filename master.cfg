from buildbot.plugins import *
import os

BUILDBOT_ADMIN_PORT = int(os.environ['BUILDBOT_ADMIN_PORT'])
BUILDBOT_COMMS_PORT = int(os.environ['BUILDBOT_COMMS_PORT'])

//----------------------------------------------------------------------
c['workers'] = [
    worker.Worker('worker1', 'password')
]

//----------------------------------------------------------------------
checkout = steps.Git(repourl='git://github.com/ucb-bar/project-template.git', mode='incremental')


// setup the steps to run
rv-tools-factory = util.BuildFactory()
rv-tools-factory.addStep(checkout)
//verilator-factory = util.BuildFactory()
//esp-tools-factory = util.BuildFactory()
prep-hwacha-factory = util.BuildFactory()
prep-hwacha-factory.addStep(checkout)
//prep-boom-factory = util.BuildFactory()
//prep-boomexample-factory = util.BuildFactory()
//prep-boomrocketexample-factory = util.BuildFactory()
//prep-rocketchip-factory = util.BuildFactory()
//prep-example-factory = util.BuildFactory()
run-hwacha-test-factory = util.BuildFactory()
run-hwacha-test-factory.addStep(checkout)

c['builders'] = [
    util.BuilderConfig(name='riscv-tools-install', factory=rv-tools-factory, workernames=['worker1'])
    util.BuilderConfig(name='prep-hwacha', factory=prep-hwacha-factory, workernames=['worker1'])
    util.BuilderConfig(name='hwacha-test', factory=run-hwacha-test-factory, workernames=['worker1'])
]


//----------------------------------------------------------------------
prep-tools = schedulers.SingleBranchScheduler(
    name='prep-tools',
    branch='master',
    builderNames=['riscv-tools-install'],
    hour=3,
    minute=0))

prep-rtl-sims = schedulers.Dependent(
    name='prep-rtl-sims',
    upstream=prep-tools,
    builderNames=['prep-hwacha-factory'])

run-tests = schedulers.Dependent(
    name='run-tests',
    upstream=prep-rtl-sims,
    builderNames=['hwacha-test'])

force-sched = schedulers.ForceScheduler(
    name='force',
    builderNames=['hwacha-test'])

c['schedulers'] = [prep-tools, prep-rtl-sims, run-tests, force-sched]

//----------------------------------------------------------------------
c['protocols'] = {'pb': {'port': BUILDBOT_COMMS_PORT}}

//----------------------------------------------------------------------
c['buildbotURL'] = f'http://localhost:{BUILDBOT_ADMIN_PORT}/'

//----------------------------------------------------------------------
c['www'] = dict(
    port=BUILDBOT_ADMIN_PORT,
    plugins=dict(
        waterfall_view={True},
        console_view={True},
        grid_view={True}),
    change_hook_dialects={'github':{'secret': None, 'pullrequest_ref':'direct'})
